<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScandiKitchen Master Pro v2.5</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        :root { --milk: #f4f1ea; --olive: #556b2f; --text: #333; --white: #ffffff; --accent: #d4e0c0; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--milk); color: var(--text); margin: 0; padding-bottom: 80px; }
        
        /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Header */
        header { background: var(--white); padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .logo { cursor: pointer; font-weight: bold; color: var(--olive); font-size: 1.4rem; }

        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        
        /* –°–µ—Ç–∫–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤ */
        .recipe-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; position: relative; }
        
        /* –ö–Ω–æ–ø–∫–∏ –ø–æ –¢–ó (–º–∏–Ω–∏–º—É–º 44px –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö) */
        .btn { padding: 12px 20px; border-radius: 15px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; text-decoration: none; min-height: 44px; }
        .btn-olive { background: var(--olive); color: white; }
        .btn-day { width: 50px; height: 50px; font-size: 1.1rem; } 

        /* –†–µ–∂–∏–º –≥–æ—Ç–æ–≤–∫–∏: –°–ª–æ–≤–æ –≤ —Å–ª–æ–≤–æ */
        .content-text { white-space: pre-line; line-height: 1.6; font-size: 1rem; }
        .step-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.3s; }
        .step-item.done { opacity: 0.4; text-decoration: line-through; border-left: 5px solid var(--olive); background: #fdfdfd; }

        /* –¢–∞–π–º–µ—Ä –∏ –í–∏–¥–∂–µ—Ç—ã */
        .timer-btn { background: var(--accent); color: var(--olive); padding: 2px 6px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .floating-timer { position: fixed; bottom: 20px; right: 20px; background: var(--olive); color: white; padding: 15px 25px; border-radius: 50px; z-index: 2000; display: flex; align-items: center; gap: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        
        /* –§–æ—Ç–æ */
        .photo-upload-label { display: block; margin-top: 10px; font-size: 0.9rem; color: var(--olive); text-decoration: underline; cursor: pointer; text-align: center; }

        /* –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫: –°–µ—Ç–∫–∞ */
        .day-row { background: white; padding: 15px; border-radius: 15px; margin-bottom: 10px; border: 1px solid #e0ddd5; position: relative; }
        .remove-btn { color: #ff5f5f; font-weight: bold; cursor: pointer; font-size: 1.2rem; padding: 5px; }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 3000; }
        .modal { background: white; padding: 30px; border-radius: 25px; width: 90%; max-width: 450px; }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <div class="logo" @click="page = 'home'">üåø ScandiKitchen</div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-olive" @click="page = 'planner'">üìÖ –ü–õ–ê–ù</button>
                <button class="btn" style="background:#ddd" @click="page = 'shopping'">üõí –ü–û–ö–£–ü–ö–ò</button>
            </div>
        </header>

        <main class="container">
            <div v-if="page === 'home'">
                <input type="text" v-model="search" placeholder="–ü–æ–∏—Å–∫ –±–ª—é–¥–∞ –∏–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–∞..." style="width:100%; padding:15px; border-radius:15px; border:1px solid #ddd; margin-bottom:15px; font-size:1rem;">
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                    <select v-model="selCat" style="padding:12px; border-radius:15px; border:1px solid #ddd;">
                        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                        <option v-for="c in categories" :value="c">{{c}}</option>
                    </select>
                    <select v-model="selSub" v-if="subCategories.length" style="padding:12px; border-radius:15px; border:1px solid #ddd;">
                        <option value="">–í—Å–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                        <option v-for="s in subCategories" :value="s">{{s}}</option>
                    </select>
                </div>

                <div class="recipe-grid">
                    <div v-for="r in filteredRecipes" :key="r.id" class="card" @click="openRecipe(r)">
                        <div style="height:180px; background:#eee; border-radius:15px; overflow:hidden;">
                            <img :src="userPhotos[r.id] || r.image" style="width:100%; height:100%; object-fit:cover;">
                        </div>
                        <h3 style="margin:12px 0 5px 0">{{r.title}}</h3>
                        <div style="font-size:0.8rem; color:#666;">üî• {{r.kcal}} –∫–∫–∞–ª | ü•© {{r.prot}}–≥ –±–µ–ª–∫–∞</div>
                    </div>
                </div>
            </div>

            <div v-if="page === 'recipe'">
                <button @click="page = 'home'" class="btn" style="background:none; color:var(--olive); padding-left:0;">‚Üê –ö —Å–ø–∏—Å–∫—É</button>
                <h1 style="margin-top:10px;">{{curR.title}}</h1>

                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:30px;">
                    <div>
                        <div style="width:100%; height:300px; background:#ddd; border-radius:20px; overflow:hidden;">
                            <img :src="userPhotos[curR.id] || curR.image" style="width:100%; height:100%; object-fit:cover;">
                        </div>
                        <label class="photo-upload-label">
                            üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ
                            <input type="file" @change="uploadPhoto" hidden accept="image/*">
                        </label>
                        <a v-if="curR.video" :href="curR.video" target="_blank" class="btn" style="width:100%; background:#24A1DE; color:white; margin-top:15px;">üé¨ –í–ò–î–ï–û-–£–†–û–ö</a>
                        <button class="btn btn-olive" style="width:100%; margin-top:10px;" @click="showDayModal = true">üìÖ –í –ü–õ–ê–ù –ü–ò–¢–ê–ù–ò–Ø</button>
                    </div>

                    <div>
                        <h3>üõí –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã ({{servings}} –ø–æ—Ä—Ü.)</h3>
                        <div style="display:flex; gap:10px; margin-bottom:15px;">
                            <button class="btn" @click="servings > 1 ? servings-- : 1" style="flex:1; background:#eee;">-</button>
                            <button class="btn" @click="servings++" style="flex:1; background:#eee;">+</button>
                        </div>
                        <div v-for="i in curR.ingredients" :key="i.name" style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee;">
                            <span>{{i.name}}</span>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <b>{{(i.amount / curR.servings * servings).toFixed(0)}} {{i.unit}}</b>
                                <input type="number" v-model.number="stock[i.name]" placeholder="–ï—Å—Ç—å" style="width:55px; padding:5px; border-radius:8px; border:1px solid #ddd; text-align:center;">
                            </div>
                        </div>
                    </div>
                </div>

                <h3>üë®‚Äçüç≥ –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ (–°–ª–æ–≤–æ –≤ —Å–ª–æ–≤–æ)</h3>
                <div class="card content-text">
                    <div v-for="(step, idx) in curR.steps" :key="idx" 
                         :class="['step-item', doneSteps[curR.id]?.includes(idx) ? 'done' : '']"
                         @click="toggleStep(idx)">
                        <span v-html="formatStep(step)"></span>
                    </div>
                </div>
            </div>

            <div v-if="page === 'planner'">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h2>–ú–æ–π –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è</h2>
                    <button class="btn" style="color:red; background:none;" @click="clearWeek">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
                </div>

                <div v-for="day in days" :key="day" class="day-row">
                    <b style="color:var(--olive); font-size:1.1rem;">{{day}}</b>
                    <div v-for="(item, idx) in plan[day]" :key="idx" style="display:flex; justify-content:space-between; margin-top:8px; align-items:center;">
                        <span>{{item.title}} ({{item.servs}} –ø–æ—Ä—Ü.)</span>
                        <span class="remove-btn" @click="removeItem(day, idx)">√ó</span>
                    </div>
                    <div v-if="!plan[day].length" style="color:#bbb; font-size:0.9rem; margin-top:5px;">–ù–∏—á–µ–≥–æ –Ω–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</div>
                </div>

                <div class="card" style="margin-top:30px; background: #eef2e6;">
                    <h3>üì¶ –®–∞–±–ª–æ–Ω—ã –º–µ–Ω—é</h3>
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <input type="text" v-model="newTplName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞..." style="flex:1; padding:12px; border-radius:15px; border:1px solid #ccc;">
                        <button class="btn btn-olive" @click="saveTemplate">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                    <div v-for="(tpl, name) in templates" :key="name" style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:white; border-radius:15px; margin-bottom:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                        <span @click="loadTemplate(name)" style="cursor:pointer; font-weight:bold; flex:1;">{{name}}</span>
                        <button @click="deleteTemplate(name)" style="background:none; border:none; color:red; cursor:pointer;">—É–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            </div>

            <div v-if="page === 'shopping'">
                <h2>–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</h2>
                <div v-if="Object.keys(shoppingList).length === 0" class="card">–í–∞—à —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –±–ª—é–¥–∞ –≤ –ø–ª–∞–Ω!</div>
                <div v-for="(items, dept) in shoppingList" :key="dept">
                    <h3 style="color:var(--olive); margin-top:25px; border-bottom:2px solid var(--accent);">{{dept}}</h3>
                    <div v-for="item in items" :key="item.name" style="padding:10px 0; display:flex; justify-content:space-between; border-bottom:1px solid #f0f0f0;">
                        <span><input type="checkbox" style="margin-right:10px;"> {{item.name}}</span>
                        <b>{{item.amount}} {{item.unit}}</b>
                    </div>
                </div>
                <button v-if="Object.keys(shoppingList).length" class="btn btn-olive" style="width:100%; background:#24A1DE; margin-top:30px;" @click="exportTelegram">‚úàÔ∏è –û–¢–ü–†–ê–í–ò–¢–¨ –í TELEGRAM</button>
            </div>

            <div class="overlay" v-if="showDayModal" @click.self="showDayModal = false">
                <div class="modal">
                    <h3>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏:</h3>
                    <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:12px;">
                        <button v-for="d in days" :key="d" @click="addToPlan(d)" class="btn btn-olive btn-day">{{d}}</button>
                    </div>
                </div>
            </div>

            <div v-if="timeLeft > 0" class="floating-timer">
                <span style="font-size:1.2rem; font-weight:bold;">‚è± {{ Math.floor(timeLeft / 60) }}:{{ (timeLeft % 60).toString().padStart(2, '0') }}</span>
                <button @click="resetTimer" style="background:none; border:none; color:white; font-size:1.6rem; cursor:pointer; padding:0 5px;">‚úï</button>
            </div>
        </main>
    </div>

    <script src="recipes.js"></script>
    <script>
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    page: 'home', search: '', selCat: '', selSub: '',
                    categories: ['üçú –°—É–ø—ã','ü•ó –°–∞–ª–∞—Ç—ã','ü•© –û—Å–Ω–æ–≤–Ω—ã–µ (–º—è—Å–æ, –ø—Ç–∏—Ü–∞)','üêü –û—Å–Ω–æ–≤–Ω—ã–µ (—Ä—ã–±–∞)','üçö –ì–∞—Ä–Ω–∏—Ä—ã','ü•ß –í—ã–ø–µ—á–∫–∞','üç∞ –î–µ—Å–µ—Ä—Ç—ã','üçπ –ù–∞–ø–∏—Ç–∫–∏','ü•® –ó–∞–∫—É—Å–∫–∏','üßÇ –°–æ—É—Å—ã'],
                    days: ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'],
                    recipes: typeof myRecipes !== 'undefined' ? myRecipes : [],
                    curR: null, servings: 1, timeLeft: 0, timer: null, showDayModal: false,
                    newTplName: '',
                    stock: JSON.parse(localStorage.getItem('sk_stock') || '{}'),
                    plan: JSON.parse(localStorage.getItem('sk_plan') || '{"–ü–Ω":[],"–í—Ç":[],"–°—Ä":[],"–ß—Ç":[],"–ü—Ç":[],"–°–±":[],"–í—Å":[]}'),
                    doneSteps: JSON.parse(localStorage.getItem('sk_steps') || '{}'),
                    userPhotos: JSON.parse(localStorage.getItem('sk_photos') || '{}'),
                    templates: JSON.parse(localStorage.getItem('sk_templates') || '{}')
                }
            },
            computed: {
                subCategories() {
                    if (!this.selCat) return [];
                    const subs = this.recipes.filter(r => r.category === this.selCat).map(r => r.subcategory);
                    return [...new Set(subs)].filter(s => s);
                },
                filteredRecipes() {
                    return this.recipes.filter(r => {
                        const mS = r.title.toLowerCase().includes(this.search.toLowerCase()) || r.ingredients.some(i => i.name.toLowerCase().includes(this.search.toLowerCase()));
                        const mC = !this.selCat || r.category === this.selCat;
                        const mSub = !this.selSub || r.subcategory === this.selSub;
                        return mS && mC && mSub;
                    });
                },
                shoppingList() {
                    let total = {};
                    Object.values(this.plan).flat().forEach(p => {
                        const r = this.recipes.find(x => x.title === p.title);
                        if(r) r.ingredients.forEach(i => {
                            if(!total[i.name]) total[i.name] = { amount: 0, unit: i.unit, dept: i.dept || '–†–∞–∑–Ω–æ–µ' };
                            total[i.name].amount += (i.amount / r.servings) * p.servs;
                        });
                    });
                    let grouped = {};
                    for(let name in total) {
                        let buy = Math.max(0, total[name].amount - (this.stock[name] || 0));
                        if(buy > 0) {
                            let d = total[name].dept;
                            if(!grouped[d]) grouped[d] = [];
                            grouped[d].push({ name, amount: Math.ceil(buy), unit: total[name].unit });
                        }
                    }
                    return grouped;
                }
            },
            methods: {
                openRecipe(r) { this.curR = r; this.servings = r.servings; this.page = 'recipe'; window.scrollTo(0,0); },
                formatStep(t) { return t.replace(/(\d+)\s*(–º–∏–Ω—É—Ç|–º–∏–Ω)/g, (m, v) => `<span class="timer-btn" onclick="event.stopPropagation(); window.runT(${v})">${m}</span>`); },
                playBeep() {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    const g = ctx.createGain();
                    osc.connect(g); g.connect(ctx.destination);
                    osc.frequency.setValueAtTime(600, ctx.currentTime);
                    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.1);
                    osc.start(); osc.stop(ctx.currentTime + 0.1);
                },
                toggleStep(idx) {
                    if(!this.doneSteps[this.curR.id]) this.doneSteps[this.curR.id] = [];
                    const arr = this.doneSteps[this.curR.id];
                    if(!arr.includes(idx)) { arr.push(idx); this.playBeep(); }
                    else { arr.splice(arr.indexOf(idx), 1); }
                    localStorage.setItem('sk_steps', JSON.stringify(this.doneSteps));
                },
                uploadPhoto(e) {
                    const file = e.target.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = (f) => {
                        this.userPhotos[this.curR.id] = f.target.result;
                        localStorage.setItem('sk_photos', JSON.stringify(this.userPhotos));
                    };
                    reader.readAsDataURL(file);
                },
                addToPlan(day) {
                    this.plan[day].push({ title: this.curR.title, servs: this.servings });
                    this.save(); this.showDayModal = false;
                },
                removeItem(day, idx) { this.plan[day].splice(idx, 1); this.save(); },
                clearWeek() { if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –ø–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é?')) { Object.keys(this.plan).forEach(d => this.plan[d] = []); this.save(); } },
                save() { 
                    localStorage.setItem('sk_plan', JSON.stringify(this.plan));
                    localStorage.setItem('sk_stock', JSON.stringify(this.stock));
                },
                saveTemplate() {
                    if(!this.newTplName) return;
                    this.templates[this.newTplName] = JSON.parse(JSON.stringify(this.plan));
                    localStorage.setItem('sk_templates', JSON.stringify(this.templates));
                    this.newTplName = ''; alert('–ü–ª–∞–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –∞—Ä—Ö–∏–≤–µ!');
                },
                loadTemplate(n) { 
                    if(confirm(`–ó–∞–≥—Ä—É–∑–∏—Ç—å —à–∞–±–ª–æ–Ω "${n}"? –¢–µ–∫—É—â–∏–π –ø–ª–∞–Ω –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω.`)) {
                        this.plan = JSON.parse(JSON.stringify(this.templates[n])); 
                        this.save(); 
                    }
                },
                deleteTemplate(n) { if(confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω?')) { delete this.templates[n]; localStorage.setItem('sk_templates', JSON.stringify(this.templates)); } },
                resetTimer() { clearInterval(this.timer); this.timeLeft = 0; },
                exportTelegram() {
                    let msg = "üåø –ú–û–ô –ü–õ–ê–ù –ò –ü–û–ö–£–ü–ö–ò:\n";
                    for(let d in this.shoppingList) {
                        msg += `\nüì¶ ${d.toUpperCase()}:\n`;
                        this.shoppingList[d].forEach(i => msg += `‚Ä¢ ${i.name}: ${i.amount}${i.unit}\n`);
                    }
                    window.location.href = `tg://msg?text=${encodeURIComponent(msg)}`;
                }
            },
            mounted() {
                window.runT = (m) => {
                    this.timeLeft = m * 60;
                    if(this.timer) clearInterval(this.timer);
                    this.timer = setInterval(() => {
                        this.timeLeft--;
                        if(this.timeLeft <= 0) { clearInterval(this.timer); alert('‚è± –í—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –≤—ã—à–ª–æ!'); }
                    }, 1000);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
