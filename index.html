<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåø ScandiKitchen Ultra</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        :root { --olive: #556b2f; --milk: #f4f1ea; --white: #ffffff; --text: #333; --gray: #888; }
        body.dark-mode { --milk: #121212; --white: #1e1e1e; --text: #e0e0e0; --gray: #aaa; }
        
        body { font-family: 'Inter', sans-serif; background: var(--milk); color: var(--text); margin: 0; padding-bottom: 80px; transition: 0.3s; }
        header { background: var(--white); padding: 15px 5%; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .nav-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        
        input[type="text"] { width: 100%; padding: 12px 20px; border-radius: 25px; border: 1px solid #ddd; background: var(--white); color: var(--text); outline: none; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        
        .cat-title { color: var(--olive); font-size: 1.8rem; border-left: 5px solid var(--olive); padding-left: 15px; margin-top: 40px; }
        .recipe-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .recipe-card { background: var(--white); border-radius: 15px; overflow: hidden; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .recipe-img-box { width: 100%; height: 200px; background: #333; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        
        .servings-ctrl { display: flex; align-items: center; gap: 15px; background: rgba(85,107,47,0.1); padding: 10px 20px; border-radius: 25px; margin: 15px 0; width: fit-content; }
        .step-item { padding: 15px; border-radius: 12px; background: var(--white); margin-bottom: 12px; cursor: pointer; border: 1px solid rgba(0,0,0,0.05); line-height: 1.6; transition: 0.2s; }
        .step-item.done { opacity: 0.5; background: #dcfce7; color: #166534; text-decoration: line-through; border-color: #bbf7d0; }
        
        .shop-card { background: var(--white); padding: 25px; border-radius: 20px; border: 2px solid var(--olive); }
        .btn { padding: 12px 24px; border-radius: 25px; border: none; cursor: pointer; font-weight: 600; font-family: inherit; transition: 0.2s; }
        .btn-olive { background: var(--olive); color: white; }
        .btn-mode { background: #444; color: white; font-size: 0.8rem; }
        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--white); padding: 25px; border-radius: 20px; z-index: 1000; width: 90%; max-width: 400px; }
    </style>
</head>
<body :class="{'dark-mode': darkMode}">
    <div id="app">
        <header>
            <div class="nav-top">
                <div @click="page = 'home'" style="cursor:pointer; font-weight:600; color:var(--olive); font-size:1.4rem;">üåø ScandiKitchen</div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-mode" @click="darkMode = !darkMode">{{ darkMode ? '‚òÄÔ∏è –°–í–ï–¢' : 'üåô –¢–¨–ú–ê' }}</button>
                    <button class="btn btn-olive" @click="page = 'planner'">üõí –°–ü–ò–°–û–ö</button>
                </div>
            </div>
            <input type="text" v-if="page === 'home'" v-model="search" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—É...">
        </header>

        <div class="container">
            <div v-if="page === 'home'">
                <div v-for="cat in uniqueCategories" :key="cat">
                    <h2 class="cat-title">{{ cat }}</h2>
                    <div v-for="sub in getSubcategories(cat)" :key="sub">
                        <h4 style="color:var(--gray); margin: 25px 0 10px; letter-spacing: 1px;">{{ sub.toUpperCase() }}</h4>
                        <div class="recipe-grid">
                            <div v-for="r in filteredRecipes(cat, sub)" :key="r.id" class="recipe-card" @click="openRecipe(r)">
                                <div class="recipe-img-box">
                                    <img v-if="userPhotos[r.id]" :src="userPhotos[r.id]" style="width:100%; height:100%; object-fit:cover;">
                                    <span v-else style="color:white">üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ</span>
                                </div>
                                <div style="padding:15px;"><h3>{{ r.title }}</h3></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="page === 'recipe'">
                <button class="btn" @click="page = 'home'" style="background:#ddd;">‚Üê –ö –†–ï–¶–ï–ü–¢–ê–ú</button>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:40px; margin-top:30px;">
                    <div>
                        <div class="recipe-img-box" style="height:400px; border-radius:20px; box-shadow: 0 15px 30px rgba(0,0,0,0.2);">
                            <img v-if="userPhotos[currentRecipe.id]" :src="userPhotos[currentRecipe.id]" style="width:100%; height:100%; object-fit:cover;">
                            <span v-else style="color:white">–§–û–¢–û –ù–ï –ó–ê–ì–†–£–ñ–ï–ù–û</span>
                        </div>
                        <label class="btn" style="background:#eee; display:block; margin:15px 0; text-align:center; color:#333;">
                            üì∑ –ó–ê–ì–†–£–ó–ò–¢–¨ / –ò–ó–ú–ï–ù–ò–¢–¨ –§–û–¢–û
                            <input type="file" @change="uploadPhoto" hidden accept="image/*">
                        </label>
                        <div class="servings-ctrl">
                            <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ä—Ü–∏–π:</span>
                            <button @click="servings > 1 ? servings-- : null" class="btn" style="padding:5px 15px;">-</button>
                            <b style="font-size:1.2rem;">{{ servings }}</b>
                            <button @click="servings++" class="btn" style="padding:5px 15px;">+</button>
                        </div>
                        <button class="btn btn-olive" style="width:100%;" @click="showPicker = true">üìÖ –î–û–ë–ê–í–ò–¢–¨ –í –ü–õ–ê–ù</button>
                        <a v-if="currentRecipe.video" :href="currentRecipe.video" target="_blank" class="btn" style="background:#24A1DE; color:white; width:100%; margin-top:10px; display:block;">üé¨ –°–ú–û–¢–†–ï–¢–¨ –í–ò–î–ï–û</a>
                    </div>
                    <div>
                        <h1 style="margin-top:0;">{{ currentRecipe.title }}</h1>
                        <p style="color:var(--olive); font-weight:600;">{{ currentRecipe.category }} | {{ currentRecipe.subcategory }}</p>
                        
                        <h3 style="margin-top:30px; border-bottom:1px solid #ddd; padding-bottom:10px;">üõí –ò–ù–ì–†–ï–î–ò–ï–ù–¢–´</h3>
                        <ul style="list-style:none; padding:0;">
                            <li v-for="ing in currentRecipe.ingredients" style="padding:10px 0; border-bottom:1px dotted #ccc; display:flex; justify-content:space-between;">
                                <span>üîπ {{ ing.name }}</span>
                                <b style="color:var(--olive)">{{ calculateAmount(ing.amount) }} {{ ing.unit }}</b>
                            </li>
                        </ul>

                        <h3 style="margin-top:40px; border-bottom:1px solid #ddd; padding-bottom:10px;">üë®‚Äçüç≥ –ü–û–®–ê–ì–û–í–´–ô –ü–õ–ê–ù</h3>
                        <p style="font-size:0.8rem; color:var(--gray); margin-bottom:15px;">–ù–∞–∂–∏–º–∞–π—Ç–µ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–π —à–∞–≥, —á—Ç–æ–±—ã –Ω–µ –∑–∞–ø—É—Ç–∞—Ç—å—Å—è:</p>
                        <div v-for="(step, idx) in currentRecipe.steps" :key="idx" 
                             class="step-item" :class="{done: isStepDone(idx)}"
                             @click="toggleStep(idx)">
                            {{ step }}
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="page === 'planner'">
                <button class="btn" @click="page = 'home'" style="background:#ddd;">‚Üê –ù–ê–ó–ê–î</button>
                <div class="shop-card" style="margin-top:30px;">
                    <h2 style="margin-top:0;">üõí –í–ê–® –°–ü–ò–°–û–ö –ü–û–ö–£–ü–û–ö</h2>
                    <div v-if="Object.keys(summarizedList).length === 0" style="padding:40px; text-align:center; color:var(--gray);">
                        –ü–ª–∞–Ω –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ —Ä–µ—Ü–µ–ø—Ç—ã –≤ –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è!
                    </div>
                    <div v-for="(val, name) in summarizedList" :key="name" 
                         style="display:flex; justify-content:space-between; align-items:center; padding:15px 0; border-bottom:1px solid #eee;"
                         :class="{ completed: getInvn(name).done }">
                        <div style="display:flex; align-items:center;">
                            <input type="checkbox" v-model="getInvn(name).done" @change="saveInvn" style="width:20px; height:20px; cursor:pointer;">
                            <span style="margin-left:15px; font-weight:600;">{{ name }}</span>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:0.8rem; color:var(--gray);">–ï–°–¢–¨ –î–û–ú–ê:</div>
                            <input type="number" v-model.number="getInvn(name).have" style="width:60px; padding:5px; border:1px solid #ddd; border-radius:5px;" @input="saveInvn">
                            <div style="font-weight:600; color:var(--olive); margin-top:5px;">
                                –ö–£–ü–ò–¢–¨: {{ (val.amount - (inventory[name]?.have || 0)) > 0 ? (val.amount - (inventory[name]?.have || 0)).toFixed(1).replace('.0','') + ' ' + val.unit : '‚úÖ' }}
                            </div>
                        </div>
                    </div>
                    <button v-if="Object.keys(summarizedList).length > 0" class="btn btn-olive" style="width:100%; margin-top:30px; padding:20px;" @click="sendToTelegram">
                        ‚úàÔ∏è –û–¢–ü–†–ê–í–ò–¢–¨ –ü–õ–ê–ù –ò –°–ü–ò–°–û–ö –í TELEGRAM
                    </button>
                </div>
            </div>
        </div>

        <div class="overlay" v-if="showPicker" @click="showPicker = false"></div>
        <div class="modal" v-if="showPicker">
            <h3 style="margin-top:0;">–í –ö–ê–ö–û–ô –î–ï–ù–¨ –ì–û–¢–û–í–ò–ú?</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button v-for="day in ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å']" @click="addToPlan(day)" 
                        class="btn" style="background:#f0f0f0; color:#333;">{{ day }}</button>
            </div>
        </div>
    </div>

    <script src="recipes.js"></script>
    <script>
        const { createApp } = Vue
        createApp({
            data() {
                return {
                    page: 'home', search: '', showPicker: false, darkMode: false,
                    recipes: typeof myRecipes !== 'undefined' ? myRecipes : [],
                    currentRecipe: null, servings: 1,
                    userPhotos: JSON.parse(localStorage.getItem('userPhotos') || '{}'),
                    inventory: JSON.parse(localStorage.getItem('userInventory') || '{}'),
                    stepProgress: JSON.parse(localStorage.getItem('stepProgress') || '{}'),
                    plan: JSON.parse(localStorage.getItem('userPlan') || '{"–ü–Ω":[],"–í—Ç":[],"–°—Ä":[],"–ß—Ç":[],"–ü—Ç":[],"–°–±":[],"–í—Å":[]}')
                }
            },
            computed: {
                uniqueCategories() { return [...new Set(this.recipes.map(r => r.category))]; },
                summarizedList() {
                    let sum = {};
                    Object.values(this.plan).flat().forEach(item => {
                        const r = this.recipes.find(rec => rec.title === item.title);
                        if (r) r.ingredients.forEach(i => {
                            if(!sum[i.name]) sum[i.name] = { amount: 0, unit: i.unit };
                            sum[i.name].amount += i.amount;
                        });
                    });
                    return sum;
                }
            },
            methods: {
                getSubcategories(cat) { return [...new Set(this.recipes.filter(r => r.category === cat).map(r => r.subcategory))]; },
                filteredRecipes(cat, sub) {
                    return this.recipes.filter(r => {
                        const matchSearch = r.title.toLowerCase().includes(this.search.toLowerCase()) || 
                                          r.ingredients.some(i => i.name.toLowerCase().includes(this.search.toLowerCase()));
                        return r.category === cat && r.subcategory === sub && matchSearch;
                    });
                },
                openRecipe(r) { 
                    this.currentRecipe = r; 
                    this.servings = r.servings || 1;
                    this.page = 'recipe'; 
                    window.scrollTo(0,0); 
                },
                calculateAmount(amt) { return ((amt / (this.currentRecipe.servings || 1)) * this.servings).toFixed(1).replace('.0', ''); },
                isStepDone(idx) { return this.stepProgress[this.currentRecipe.id]?.includes(idx); },
                toggleStep(idx) {
                    if(!this.stepProgress[this.currentRecipe.id]) this.stepProgress[this.currentRecipe.id] = [];
                    const list = this.stepProgress[this.currentRecipe.id];
                    list.includes(idx) ? list.splice(list.indexOf(idx), 1) : list.push(idx);
                    localStorage.setItem('stepProgress', JSON.stringify(this.stepProgress));
                },
                getInvn(name) { if(!this.inventory[name]) this.inventory[name] = {have:0, done:false}; return this.inventory[name]; },
                saveInvn() { localStorage.setItem('userInventory', JSON.stringify(this.inventory)); },
                uploadPhoto(e) {
                    const reader = new FileReader();
                    reader.onload = (f) => {
                        this.userPhotos[this.currentRecipe.id] = f.target.result;
                        localStorage.setItem('userPhotos', JSON.stringify(this.userPhotos));
                    };
                    reader.readAsDataURL(e.target.files[0]);
                },
                addToPlan(day) {
                    this.plan[day].push({ title: this.currentRecipe.title });
                    localStorage.setItem('userPlan', JSON.stringify(this.plan));
                    this.showPicker = false;
                },
                sendToTelegram() {
                    let text = "üìã –ú–û–ô –ü–õ–ê–ù –ü–ò–¢–ê–ù–ò–Ø üåø\n\n";
                    for(let day in this.plan) {
                        if(this.plan[day].length) text += `üìç ${day}: ${this.plan[day].map(p=>p.title).join(', ')}\n`;
                    }
                    text += "\nüõí –ö–£–ü–ò–¢–¨ –í –ú–ê–ì–ê–ó–ò–ù–ï:\n";
                    for(let name in this.summarizedList) {
                        const buy = this.summarizedList[name].amount - (this.inventory[name]?.have || 0);
                        if(buy > 0 && !this.inventory[name]?.done) text += `- ${name}: ${buy.toFixed(1).replace('.0','')} ${this.summarizedList[name].unit}\n`;
                    }
                    window.open(`https://t.me/share/url?url=${encodeURIComponent(text)}`, '_blank');
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
