<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ScandiKitchen v3.0 Master</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="recipes.js"></script>
    <style>
        :root {
            --bg: #f4f1ea; 
            --olive: #556b2f; 
            --light: #d4e0c0; 
            --white: #ffffff; 
            --text: #2c3e50;
            --shadow: 0 8px 24px rgba(0,0,0,0.05);
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding-bottom: 50px;
            line-height: 1.6;
        }

        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }

        /* HEADER & NAVIGATION */
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
        }
        .logo { 
            font-size: 26px; 
            font-weight: bold; 
            color: var(--olive); 
            cursor: pointer; 
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .nav-buttons { display: flex; gap: 12px; }

        /* BUTTONS */
        .btn {
            background: var(--olive);
            color: white;
            border: none;
            padding: 12px 22px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn:active { transform: scale(0.95); }
        .btn-outline { background: #e0e0e0; color: var(--text); }
        .btn-blue { background: #24A1DE; }

        /* SEARCH & FILTERS */
        .search-input {
            width: 100%; 
            padding: 18px; 
            border-radius: 15px; 
            border: none;
            box-shadow: var(--shadow); 
            font-size: 16px; 
            margin-bottom: 20px;
            box-sizing: border-box;
            outline: none;
        }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 10px;
            margin-bottom: 30px;
        }
        .tab { 
            padding: 14px; 
            background: var(--white); 
            border-radius: 15px; 
            cursor: pointer; 
            text-align: center;
            box-shadow: var(--shadow);
            border: 2px solid transparent;
            transition: 0.2s;
            font-size: 14px;
        }
        .tab.active { border-color: var(--olive); font-weight: bold; background: #fdfdfb; }

        /* RECIPE CARDS */
        .recipe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }
        .card { 
            background: var(--white); 
            border-radius: 20px; 
            padding: 25px; 
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        .recipe-card { cursor: pointer; transition: 0.3s; }
        .recipe-card:hover { transform: translateY(-5px); }

        /* RECIPE DETAIL */
        .photo-area {
            width: 100%;
            height: 300px;
            background: #e2e2e2;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 25px;
            cursor: pointer;
        }
        .photo-area img { width: 100%; height: 100%; object-fit: cover; }
        
        .instr-step { 
            padding: 12px; 
            border-radius: 12px; 
            cursor: pointer; 
            white-space: pre-line; 
            transition: 0.2s;
        }
        .instr-step:hover { background: #f9f9f7; }
        .instr-step.done { opacity: 0.4; text-decoration: line-through; }
        
        .timer-btn {
            background: var(--light);
            color: var(--olive);
            padding: 2px 8px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }

        /* TIMER WIDGET */
        .timer-widget {
            position: fixed; 
            bottom: 30px; 
            right: 30px; 
            background: var(--olive); 
            color: white;
            padding: 20px 30px; 
            border-radius: 40px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000; 
            display: flex; 
            align-items: center; 
            gap: 20px;
            font-size: 20px;
        }

        /* SHOPPING LIST */
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        [v-cloak] { display: none; }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <div v-if="timeLeft > 0" class="timer-widget">
            <span>‚è± {{ formatTime(timeLeft) }}</span>
            <button @click="timeLeft = 0" style="background:none; border:none; color:white; font-size:24px; cursor:pointer">‚úï</button>
        </div>

        <div class="container">
            <header>
                <div class="logo" @click="view = 'catalog'">üåø ScandiKitchen</div>
                <div class="nav-buttons">
                    <button class="btn" @click="view = 'planner'">üìÖ –ü–õ–ê–ù</button>
                    <button class="btn btn-outline" @click="view = 'shopping'">üõí –ü–û–ö–£–ü–ö–ò</button>
                </div>
            </header>

            <main v-if="view === 'catalog'">
                <input type="text" v-model="search" class="search-input" placeholder="–ü–æ–∏—Å–∫ —Ä–µ—Ü–µ–ø—Ç–∞ –∏–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–∞...">
                
                <div class="filter-grid">
                    <div class="tab" :class="{active: filterCat === ''}" @click="filterCat = ''">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
                    <div v-for="cat in mainCategories" :key="cat" class="tab" :class="{active: filterCat === cat}" @click="filterCat = cat">
                        {{cat}}
                    </div>
                </div>

                <div class="recipe-grid">
                    <div v-for="recipe in filteredRecipes" :key="recipe.id" class="card recipe-card" @click="openRecipe(recipe)">
                        <div style="font-size: 50px; margin-bottom: 15px;">{{recipe.emoji}}</div>
                        <h3 style="margin: 0 0 10px 0;">{{recipe.title}}</h3>
                        <div style="font-size: 14px; opacity: 0.6;">{{recipe.time}} –º–∏–Ω ‚Ä¢ {{recipe.calories}} –∫–∫–∞–ª</div>
                    </div>
                </div>
            </main>

            <main v-if="view === 'recipe'">
                <button @click="view = 'catalog'" class="btn btn-outline" style="margin-bottom: 20px;">‚Üê –ù–∞–∑–∞–¥</button>
                
                <div class="photo-area" @click="$refs.file.click()">
                    <img v-if="userPhotos[currentRecipe.id]" :src="userPhotos[currentRecipe.id]">
                    <div v-else style="text-align:center; opacity:0.5;">
                        <span style="font-size:40px;">üì∑</span><br>–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
                    </div>
                    <input type="file" ref="file" @change="uploadPhoto" style="display:none">
                </div>

                <h1 style="margin-bottom:10px;">{{currentRecipe.emoji}} {{currentRecipe.title}}</h1>
                
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3 style="margin:0;">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</h3>
                        <div style="display:flex; align-items:center; gap:15px;">
                            <span>–ü–æ—Ä—Ü–∏–∏: <b>{{servings}}</b></span>
                            <button @click="servings > 1 ? servings-- : null" class="btn btn-outline" style="padding:5px 12px;">-</button>
                            <button @click="servings++" class="btn btn-outline" style="padding:5px 12px;">+</button>
                        </div>
                    </div>

                    <div v-for="(ing, idx) in currentRecipe.ingredients" :key="idx" class="shop-item">
                        <span :style="{textDecoration: stockCheck[ing.name] ? 'line-through' : 'none', opacity: stockCheck[ing.name] ? 0.5 : 1}">
                            {{ing.name}}: <b>{{ calculateWeight(ing.amount) }} {{ing.unit}}</b>
                        </span>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <span style="font-size:12px; opacity:0.6;">–ï—Å—Ç—å –¥–æ–º–∞:</span>
                            <input type="number" v-model.number="stock[ing.name]" class="search-input" style="width:70px; margin:0; padding:8px; font-size:14px;">
                            <input type="checkbox" v-model="stockCheck[ing.name]" style="width:20px; height:20px; cursor:pointer;">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>–°–ø–æ—Å–æ–± –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è</h3>
                    <div v-for="(line, idx) in formattedSteps" :key="idx" 
                         class="instr-step" :class="{done: doneSteps.includes(idx)}"
                         @click="toggleStep(idx)" v-html="line">
                    </div>
                </div>

                <div style="display:flex; gap:15px; margin-top:30px;">
                    <button class="btn" style="flex:1; justify-content:center;" @click="addToPlan">üìÖ –î–û–ë–ê–í–ò–¢–¨ –í –ü–õ–ê–ù</button>
                    <a v-if="currentRecipe.videoUrl" :href="currentRecipe.videoUrl" target="_blank" class="btn btn-blue" style="flex:1; justify-content:center;">
                        üì∫ –í–ò–î–ï–û-–£–†–û–ö
                    </a>
                </div>
            </main>

            <main v-if="view === 'shopping'">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                    <h1 style="margin:0;">–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</h1>
                    <button class="btn" style="background:#c0392b;" @click="clearPlan">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>

                <div class="card">
                    <div v-for="(items, cat) in aggregatedList" :key="cat">
                        <h4 style="color:var(--olive); border-bottom:2px solid var(--light); padding-bottom:5px; margin-top:20px;">{{cat}}</h4>
                        <div v-for="item in items" :key="item.name" class="shop-item">
                            <span>{{item.name}}</span>
                            <b>{{item.buy}} {{item.unit}}</b>
                        </div>
                    </div>
                    <div v-if="Object.keys(aggregatedList).length === 0" style="text-align:center; padding:50px; opacity:0.5;">
                        –í–∞—à —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –±–ª—é–¥–∞ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–µ—Ü–µ–ø—Ç–∞.
                    </div>
                </div>

                <button v-if="Object.keys(aggregatedList).length > 0" @click="exportTelegram" class="btn btn-blue" style="width:100%; justify-content:center; padding:18px; font-size:18px;">
                    ‚úà –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram
                </button>
            </main>

            <main v-if="view === 'planner'">
                <h1>–ü–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é</h1>
                <div class="recipe-grid">
                    <div v-for="day in weekDays" :key="day" class="card">
                        <h3 style="color:var(--olive); margin-top:0;">{{day}}</h3>
                        <div v-for="(meal, idx) in getMealsForDay(day)" :key="idx" style="margin-bottom:10px; display:flex; justify-content:space-between;">
                            <span>{{meal.emoji}} {{meal.title}}</span>
                            <span @click="removeFromPlan(meal.planId)" style="color:red; cursor:pointer;">√ó</span>
                        </div>
                        <div v-if="getMealsForDay(day).length === 0" style="opacity:0.3; font-size:14px;">–ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –±–ª—é–¥</div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    view: 'catalog',
                    search: '',
                    filterCat: '',
                    currentRecipe: null,
                    servings: 2,
                    timeLeft: 0,
                    timerInt: null,
                    doneSteps: [],
                    weekDays: ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'],
                    mainCategories: ['üçú –°—É–ø—ã', 'ü•ó –°–∞–ª–∞—Ç—ã', 'ü•© –û—Å–Ω–æ–≤–Ω—ã–µ (–º—è—Å–æ, –ø—Ç–∏—Ü–∞)', 'üêü –û—Å–Ω–æ–≤–Ω—ã–µ (—Ä—ã–±–∞, –º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã)', 'üçö –ì–∞—Ä–Ω–∏—Ä—ã', 'ü•ß –í—ã–ø–µ—á–∫–∞', 'üç∞ –î–µ—Å–µ—Ä—Ç—ã', 'üçπ –ù–∞–ø–∏—Ç–∫–∏', 'ü•® –ó–∞–∫—É—Å–∫–∏', 'üßÇ –°–æ—É—Å—ã'],
                    
                    // –•—Ä–∞–Ω–∏–ª–∏—â–µ
                    plan: JSON.parse(localStorage.getItem('sk_plan_v3') || '[]'),
                    stock: JSON.parse(localStorage.getItem('sk_stock_v3') || '{}'),
                    stockCheck: JSON.parse(localStorage.getItem('sk_checks_v3') || '{}'),
                    userPhotos: JSON.parse(localStorage.getItem('sk_photos_v3') || '{}')
                }
            },
            computed: {
                filteredRecipes() {
                    return initialRecipes.filter(r => {
                        const mSearch = r.title.toLowerCase().includes(this.search.toLowerCase()) || 
                                        r.ingredients.some(i => i.name.toLowerCase().includes(this.search.toLowerCase()));
                        const mCat = this.filterCat === '' || r.mainCategory === this.filterCat;
                        return mSearch && mCat;
                    });
                },
                formattedSteps() {
                    if(!this.currentRecipe) return [];
                    return this.currentRecipe.instructions.split('\n').map(step => {
                        return step.replace(/(\d+)\s*(–º–∏–Ω—É—Ç|–º–∏–Ω)/gi, (match, p1) => {
                            return `<span class="timer-btn" onclick="window.app.startTimer(${p1})">${match}</span>`;
                        });
                    });
                },
                aggregatedList() {
                    let total = {};
                    this.plan.forEach(p => {
                        p.ingredients.forEach(ing => {
                            if(!total[ing.name]) total[ing.name] = { ...ing, amount: 0 };
                            total[ing.name].amount += (ing.amount / 2 * p.servings);
                        });
                    });

                    let grouped = {};
                    for(let name in total) {
                        const has = this.stock[name] || 0;
                        const buy = total[name].amount - has;
                        if(buy > 0 && !this.stockCheck[name]) {
                            const cat = total[name].category || '–ü—Ä–æ—á–µ–µ';
                            if(!grouped[cat]) grouped[cat] = [];
                            grouped[cat].push({ name, buy: buy.toFixed(1), unit: total[name].unit });
                        }
                    }
                    return grouped;
                }
            },
            methods: {
                openRecipe(r) {
                    this.currentRecipe = r;
                    this.view = 'recipe';
                    this.servings = 2;
                    this.doneSteps = [];
                    window.scrollTo(0,0);
                },
                calculateWeight(amt) {
                    return (amt / 2 * this.servings).toFixed(1);
                },
                toggleStep(idx) {
                    if(this.doneSteps.includes(idx)) this.doneSteps = this.doneSteps.filter(i => i !== idx);
                    else this.doneSteps.push(idx);
                },
                startTimer(m) {
                    this.timeLeft = m * 60;
                    if(this.timerInt) clearInterval(this.timerInt);
                    this.timerInt = setInterval(() => {
                        if(this.timeLeft > 0) this.timeLeft--;
                        else {
                            clearInterval(this.timerInt);
                            alert("–í—Ä–µ–º—è –≤—ã—à–ª–æ!");
                        }
                    }, 1000);
                },
                formatTime(s) {
                    const min = Math.floor(s / 60);
                    const sec = s % 60;
                    return `${min}:${sec.toString().padStart(2, '0')}`;
                },
                uploadPhoto(e) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (f) => {
                        this.userPhotos[this.currentRecipe.id] = f.target.result;
                        this.save();
                    };
                    reader.readAsDataURL(file);
                },
                addToPlan() {
                    const day = prompt("–ù–∞ –∫–∞–∫–æ–π –¥–µ–Ω—å? (–ü–Ω, –í—Ç, –°—Ä...)", "–ü–Ω");
                    if(!day) return;
                    this.plan.push({
                        ...JSON.parse(JSON.stringify(this.currentRecipe)),
                        planId: Date.now(),
                        servings: this.servings,
                        day: day
                    });
                    this.save();
                    alert("–î–æ–±–∞–≤–ª–µ–Ω–æ!");
                },
                getMealsForDay(dayShort) {
                    const map = {'–ü–Ω':'–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç':'–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä':'–°—Ä–µ–¥–∞', '–ß—Ç':'–ß–µ—Ç–≤–µ—Ä–≥', '–ü—Ç':'–ü—è—Ç–Ω–∏—Ü–∞', '–°–±':'–°—É–±–±–æ—Ç–∞', '–í—Å':'–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'};
                    return this.plan.filter(p => p.day === dayShort || p.day === map[dayShort]);
                },
                removeFromPlan(id) {
                    this.plan = this.plan.filter(p => p.planId !== id);
                    this.save();
                },
                clearPlan() {
                    if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?")) {
                        this.plan = []; this.stock = {}; this.stockCheck = {};
                        this.save();
                    }
                },
                exportTelegram() {
                    let msg = "üåø –ú–û–ô –°–ü–ò–°–û–ö –ü–û–ö–£–ü–û–ö:\n\n";
                    for(let cat in this.aggregatedList) {
                        msg += `--- ${cat.toUpperCase()} ---\n`;
                        this.aggregatedList[cat].forEach(i => msg += `‚Ä¢ ${i.name}: ${i.buy} ${i.unit}\n`);
                        msg += "\n";
                    }
                    window.location.href = `tg://msg?text=${encodeURIComponent(msg)}`;
                },
                save() {
                    localStorage.setItem('sk_plan_v3', JSON.stringify(this.plan));
                    localStorage.setItem('sk_stock_v3', JSON.stringify(this.stock));
                    localStorage.setItem('sk_checks_v3', JSON.stringify(this.stockCheck));
                    localStorage.setItem('sk_photos_v3', JSON.stringify(this.userPhotos));
                }
            },
            watch: {
                stock: { deep: true, handler() { this.save() } },
                stockCheck: { deep: true, handler() { this.save() } }
            },
            mounted() { window.app = this; }
        }).mount('#app');
    </script>
</body>
</html>
