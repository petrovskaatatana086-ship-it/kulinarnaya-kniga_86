<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ScandiKitchen Pro v3.4</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="recipes.js"></script>
    <style>
        :root {
            --bg: #f4f1ea; --olive: #556b2f; --light: #d4e0c0; --white: #ffffff; --text: #2c3e50;
        }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 60px; line-height: 1.5; }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        
        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .logo { font-size: 24px; font-weight: bold; color: var(--olive); cursor: pointer; }
        .nav-buttons { display: flex; gap: 10px; }

        /* UI Elements */
        .card { background: var(--white); border-radius: 20px; padding: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.05); margin-bottom: 20px; overflow: hidden; }
        .btn { background: var(--olive); color: white; border: none; padding: 12px 20px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-outline { background: #e0e0e0; color: var(--text); }
        .btn-blue { background: #24A1DE; color: white; }

        /* Filters */
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-bottom: 25px; }
        .tab { padding: 12px; background: var(--white); border-radius: 15px; cursor: pointer; text-align: center; font-size: 13px; border: 2px solid transparent; }
        .tab.active { background: var(--olive); color: white; font-weight: bold; }

        .search-input { width: 100%; padding: 18px; border-radius: 15px; border: none; box-shadow: 0 8px 24px rgba(0,0,0,0.05); font-size: 16px; margin-bottom: 20px; box-sizing: border-box; outline: none; }

        /* Photos */
        .recipe-photo-main { width: 100%; height: 200px; background: #e0e0e0; margin: -20px -20px 15px -20px; width: calc(100% + 40px); overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .recipe-photo-main img { width: 100%; height: 100%; object-fit: cover; }
        
        .recipe-photo-detail { width: 100%; height: 350px; border-radius: 20px; overflow: hidden; margin-bottom: 20px; background: #e0e0e0; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .recipe-photo-detail img { width: 100%; height: 100%; object-fit: cover; }

        /* Recipe Content */
        .instr-step { white-space: pre-wrap; padding: 15px; border-radius: 12px; cursor: pointer; transition: 0.2s; }
        .instr-step:hover { background: #f9f9f7; }
        .instr-step.done { opacity: 0.4; text-decoration: line-through; }
        .timer-tag { color: var(--olive); font-weight: bold; text-decoration: underline; cursor: pointer; padding: 2px 6px; background: var(--light); border-radius: 6px; }

        .ing-row { display: grid; grid-template-columns: 1fr 80px 40px; gap: 10px; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }

        /* Timer Widget */
        .timer-widget { position: fixed; bottom: 20px; right: 20px; background: var(--olive); color: white; padding: 15px 25px; border-radius: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 1000; display: flex; align-items: center; gap: 15px; font-weight: bold; }
        
        [v-cloak] { display: none; }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <div v-if="timeLeft > 0" class="timer-widget">
            <span>‚è± {{ formatTime(timeLeft) }}</span>
            <button @click="stopTimer" style="background:none; border:none; color:white; cursor:pointer; font-size:20px;">‚úï</button>
        </div>

        <div class="container">
            <header>
                <div class="logo" @click="view = 'catalog'">üåø ScandiKitchen</div>
                <div class="nav-buttons">
                    <button class="btn" @click="view = 'planner'">üìÖ –ü–õ–ê–ù</button>
                    <button class="btn btn-outline" @click="view = 'shopping'">üõí –ü–û–ö–£–ü–ö–ò</button>
                </div>
            </header>

            <main v-if="view === 'catalog'">
                <input type="text" v-model="search" class="search-input" placeholder="–ü–æ–∏—Å–∫ –±–ª—é–¥–∞ –∏–ª–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞...">
                <div class="filter-grid">
                    <div class="tab" :class="{active: filterCat === ''}" @click="filterCat = ''">–í—Å–µ</div>
                    <div v-for="cat in mainCategories" :key="cat" class="tab" :class="{active: filterCat === cat}" @click="filterCat = cat">{{cat}}</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
                    <div v-for="recipe in filteredRecipes" :key="recipe.id" class="card" @click="openRecipe(recipe)" style="cursor:pointer">
                        <div class="recipe-photo-main">
                            <img v-if="userPhotos[recipe.id]" :src="userPhotos[recipe.id]">
                            <div v-else style="font-size: 50px;">{{recipe.emoji}}</div>
                        </div>
                        <h3 style="margin:0;">{{recipe.title}}</h3>
                        <p style="opacity:0.6; font-size:14px; margin-top:5px;">{{recipe.time}} –º–∏–Ω ‚Ä¢ {{recipe.calories}} –∫–∫–∞–ª</p>
                    </div>
                </div>
            </main>

            <main v-if="view === 'recipe'">
                <button @click="view = 'catalog'" class="btn btn-outline" style="margin-bottom:20px;">‚Üê –ö –∫–∞—Ç–∞–ª–æ–≥—É</button>
                
                <div class="recipe-photo-detail" @click="$refs.fileInput.click()">
                    <img v-if="userPhotos[currentRecipe.id]" :src="userPhotos[currentRecipe.id]">
                    <span v-else>üì∑ –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</span>
                    <input type="file" ref="fileInput" @change="uploadPhoto" style="display:none">
                </div>

                <h1>{{currentRecipe.emoji}} {{currentRecipe.title}}</h1>

                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3 style="margin:0;">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</h3>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <button @click="servings > 1 ? servings-- : null" class="btn btn-outline" style="padding:5px 12px;">-</button>
                            <span style="font-weight:bold;">{{servings}} –ø–æ—Ä—Ü–∏–∏</span>
                            <button @click="servings++" class="btn btn-outline" style="padding:5px 12px;">+</button>
                        </div>
                    </div>
                    <div v-for="(ing, idx) in currentRecipe.ingredients" :key="idx" class="ing-row">
                        <span :style="{textDecoration: stockCheck[ing.name] ? 'line-through' : 'none', opacity: stockCheck[ing.name] ? 0.5 : 1}">
                            {{ing.name}}: <b>{{ (ing.amount / 2 * servings).toFixed(0) }} {{ing.unit}}</b>
                        </span>
                        <input type="number" v-model.number="stock[ing.name]" placeholder="0" style="width:100%; padding:8px; border-radius:8px; border:1px solid #ddd;">
                        <input type="checkbox" v-model="stockCheck[ing.name]" style="width:22px; height:22px;">
                    </div>
                </div>

                <div class="card">
                    <h3>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è)</h3>
                    <div v-for="(line, idx) in formattedSteps" :key="idx" 
                         class="instr-step" :class="{done: doneSteps.includes(idx)}" 
                         @click="toggleStep(idx)" v-html="line"></div>
                </div>

                <div style="display:flex; gap:12px;">
                    <button class="btn" style="flex:2;" @click="showDayPicker = true">üìÖ –î–û–ë–ê–í–ò–¢–¨ –í –ü–õ–ê–ù</button>
                    <a v-if="currentRecipe.videoUrl" :href="currentRecipe.videoUrl" target="_blank" class="btn btn-blue" style="flex:1; text-align:center;">üì∫ –í–ò–î–ï–û</a>
                </div>
            </main>

            <main v-if="view === 'planner'">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h1>–ü–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é</h1>
                    <button @click="clearPlan" class="btn" style="background:#e74c3c">–û—á–∏—Å—Ç–∏—Ç—å –ø–ª–∞–Ω</button>
                </div>
                <div v-for="day in weekDays" :key="day" class="card">
                    <h3 style="color:var(--olive); margin:0 0 15px 0; border-bottom: 2px solid var(--bg); padding-bottom: 5px;">{{day}}</h3>
                    <div v-for="meal in planByDay[day]" :key="meal.planId" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding:12px; background:#f9f9f9; border-radius:12px;">
                        <span>{{meal.emoji}} <b>{{meal.title}}</b> ({{meal.servings}} –ø–æ—Ä—Ü.)</span>
                        <button @click="removeFromPlan(meal.planId)" style="color:red; background:none; border:none; cursor:pointer; font-size:18px;">‚úï</button>
                    </div>
                    <div v-if="!planByDay[day].length" style="opacity:0.3; font-size:14px;">–ù–∏—á–µ–≥–æ –Ω–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</div>
                </div>
            </main>

            <main v-if="view === 'shopping'">
                <h1>–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</h1>
                <div class="card">
                    <div v-for="(items, cat) in aggregatedList" :key="cat">
                        <h4 style="color:var(--olive); border-bottom:2px solid var(--light); padding-bottom:5px; margin-top:20px;">{{cat}}</h4>
                        <div v-for="item in items" :key="item.name" style="padding:10px 0; display:flex; justify-content:space-between; border-bottom:1px solid #f0f0f0;">
                            <span>{{item.name}}</span>
                            <b>{{item.buy}} {{item.unit}}</b>
                        </div>
                    </div>
                    <div v-if="Object.keys(aggregatedList).length === 0" style="text-align:center; padding:50px; opacity:0.5;">
                        –í–∞—à —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –±–ª—é–¥–∞ –≤ –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è!
                    </div>
                </div>
                <button v-if="Object.keys(aggregatedList).length > 0" @click="exportToTelegram" class="btn btn-blue" style="width:100%; font-size:18px; padding:20px;">‚úà –û–¢–ü–†–ê–í–ò–¢–¨ –í TELEGRAM</button>
            </main>

            <div v-if="showDayPicker" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:2000;" @click.self="showDayPicker = false">
                <div class="card" style="width:320px; text-align:center;">
                    <h3 style="margin-top:0;">–ù–∞ –∫–∞–∫–æ–π –¥–µ–Ω—å?</h3>
                    <div v-for="day in weekDays" :key="day" @click="saveToPlan(day)" style="padding:15px; cursor:pointer; border-bottom:1px solid #eee; font-weight:bold; color:var(--olive);">{{day}}</div>
                    <button class="btn btn-outline" @click="showDayPicker = false" style="width:100%; margin-top:15px;">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const app = createApp({
            data() {
                return {
                    view: 'catalog', search: '', filterCat: '', currentRecipe: null, servings: 2, timeLeft: 0, timerInt: null,
                    doneSteps: [], showDayPicker: false,
                    mainCategories: ['üçú –°—É–ø—ã', 'ü•ó –°–∞–ª–∞—Ç—ã', 'ü•© –û—Å–Ω–æ–≤–Ω—ã–µ (–º—è—Å–æ)', 'üêü –û—Å–Ω–æ–≤–Ω—ã–µ (—Ä—ã–±–∞)', 'ü•ß –í—ã–ø–µ—á–∫–∞', 'üç∞ –î–µ—Å–µ—Ä—Ç—ã'],
                    weekDays: ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'],
                    plan: JSON.parse(localStorage.getItem('sk_plan_v34') || '[]'),
                    stock: JSON.parse(localStorage.getItem('sk_stock_v34') || '{}'),
                    stockCheck: JSON.parse(localStorage.getItem('sk_checks_v34') || '{}'),
                    userPhotos: JSON.parse(localStorage.getItem('sk_photos_v34') || '{}')
                }
            },
            computed: {
                filteredRecipes() {
                    return initialRecipes.filter(r => {
                        const mS = r.title.toLowerCase().includes(this.search.toLowerCase()) || r.ingredients.some(i => i.name.toLowerCase().includes(this.search.toLowerCase()));
                        const mC = !this.filterCat || r.mainCategory === this.filterCat;
                        return mS && mC;
                    });
                },
                formattedSteps() {
                    if(!this.currentRecipe) return [];
                    return this.currentRecipe.instructions.split('\n').map(l => {
                        return l.replace(/(\d+)\s*(–º–∏–Ω—É—Ç|–º–∏–Ω)/gi, (m, p1) => `<span class="timer-tag" onclick="window.startGlobalTimer(${p1})">${m}</span>`);
                    });
                },
                planByDay() {
                    let map = {}; this.weekDays.forEach(d => map[d] = []);
                    this.plan.forEach(p => { if(map[p.day]) map[p.day].push(p); });
                    return map;
                },
                aggregatedList() {
                    let total = {};
                    this.plan.forEach(p => {
                        p.ingredients.forEach(ing => {
                            if(!total[ing.name]) total[ing.name] = { ...ing, amount: 0 };
                            total[ing.name].amount += (ing.amount / 2 * p.servings);
                        });
                    });
                    let grouped = {};
                    for(let n in total) {
                        const has = this.stock[n] || 0;
                        const buy = Math.max(0, total[n].amount - has);
                        if(buy > 0 && !this.stockCheck[n]) {
                            const c = total[n].category || '–†–∞–∑–Ω–æ–µ';
                            if(!grouped[c]) grouped[c] = [];
                            grouped[c].push({ name: n, buy: buy.toFixed(0), unit: total[n].unit });
                        }
                    }
                    return grouped;
                }
            },
            methods: {
                openRecipe(r) { this.currentRecipe = r; this.view = 'recipe'; this.servings = 2; this.doneSteps = []; window.scrollTo(0,0); },
                toggleStep(i) { this.doneSteps.includes(i) ? this.doneSteps = this.doneSteps.filter(x => x !== i) : this.doneSteps.push(i); },
                formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; },
                uploadPhoto(e) {
                    const reader = new FileReader();
                    reader.onload = (f) => { this.userPhotos[this.currentRecipe.id] = f.target.result; this.save(); };
                    reader.readAsDataURL(e.target.files[0]);
                },
                saveToPlan(day) {
                    const newEntry = { ...JSON.parse(JSON.stringify(this.currentRecipe)), planId: Date.now(), day, servings: this.servings };
                    this.plan.push(newEntry); this.save(); this.showDayPicker = false;
                    alert(`–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–∞ ${day}`);
                },
                removeFromPlan(pid) { this.plan = this.plan.filter(p => p.planId !== pid); this.save(); },
                clearPlan() { if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –ø–ª–∞–Ω?")) { this.plan = []; this.save(); } },
                stopTimer() { this.timeLeft = 0; clearInterval(this.timerInt); },
                exportToTelegram() {
                    let txt = "üåø –ú–û–ô –ü–õ–ê–ù –ò –ü–û–ö–£–ü–ö–ò:\n";
                    this.weekDays.forEach(d => {
                        if(this.planByDay[d].length) txt += `\nüìç ${d.toUpperCase()}:\n` + this.planByDay[d].map(m => ` ‚Ä¢ ${m.title}`).join('\n') + '\n';
                    });
                    txt += "\nüõí –ù–£–ñ–ù–û –ö–£–ü–ò–¢–¨:\n";
                    for(let c in this.aggregatedList) {
                        txt += `\nüîπ ${c.toUpperCase()}:\n` + this.aggregatedList[c].map(i => ` - ${i.name}: ${i.buy} ${i.unit}`).join('\n') + '\n';
                    }
                    window.open(`https://t.me/share/url?url=${encodeURIComponent(txt)}`, '_blank');
                },
                playAlarm() {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const playNote = (time) => {
                        const osc = ctx.createOscillator(); const gain = ctx.createGain();
                        osc.type = 'sine'; osc.frequency.setValueAtTime(880, time);
                        gain.gain.setValueAtTime(0.1, time); gain.gain.exponentialRampToValueAtTime(0.01, time + 0.4);
                        osc.connect(gain); gain.connect(ctx.destination);
                        osc.start(time); osc.stop(time + 0.5);
                    };
                    [0, 0.6, 1.2].forEach(t => playNote(ctx.currentTime + t));
                },
                save() {
                    localStorage.setItem('sk_plan_v34', JSON.stringify(this.plan));
                    localStorage.setItem('sk_stock_v34', JSON.stringify(this.stock));
                    localStorage.setItem('sk_checks_v34', JSON.stringify(this.stockCheck));
                    localStorage.setItem('sk_photos_v34', JSON.stringify(this.userPhotos));
                }
            },
            watch: {
                stock: { deep: true, handler() { this.save() } },
                stockCheck: { deep: true, handler() { this.save() } }
            }
        });

        const vm = app.mount('#app');
        window.startGlobalTimer = (m) => {
            vm.timeLeft = m * 60;
            if(vm.timerInt) clearInterval(vm.timerInt);
            vm.timerInt = setInterval(() => { 
                if(vm.timeLeft > 0) vm.timeLeft--; 
                else { clearInterval(vm.timerInt); vm.playAlarm(); alert("–¢–∞–π–º–µ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω!"); }
            }, 1000);
        };
    </script>
</body>
</html>
